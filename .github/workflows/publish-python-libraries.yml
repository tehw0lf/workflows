name: publish python libraries

on:
  workflow_call:
    secrets:
      UV_TOKEN:
        required: false
    inputs:
      runner:
        description: "workflow-runner"
        default: "ubuntu-latest"
        required: false
        type: string
      root_dir:
        description: "path to project root"
        default: "."
        required: false
        type: string
      artifact_path:
        description: "path to artifact files to save from build step"
        default: ""
        required: false
        type: string
      tool:
        description: "build tool - uv"
        default: "uv"
        required: false
        type: string

jobs:
  publish_python_libraries:
    name: publish python libraries
    runs-on: ${{ inputs.runner }}
    timeout-minutes: 15
    permissions:
      actions: read
      contents: read
      packages: read
    defaults:
      run:
        working-directory: ${{ inputs.root_dir }}
    steps:
      - uses: actions/checkout@v5

      - name: check build artifact existence
        uses: softwareforgood/check-artifact-v4-existence@v0
        id: check_artifact_exists
        with:
          name: build

      - name: validate artifact availability
        if: ${{ inputs.artifact_path != '' && steps.check_artifact_exists.outputs.exists != 'true' }}
        run: |
          echo "::error::[PyPI] Build artifact 'build' not found"
          echo "::error::[PyPI] Expected artifact at: ${{ inputs.artifact_path }}"
          echo "::error::[PyPI] This usually means the build step failed or didn't produce artifacts"
          echo "FAILURE_REASON=missing_artifact" >> $GITHUB_ENV
          exit 1

      - name: download build artifact
        if: ${{ inputs.artifact_path != '' && steps.check_artifact_exists.outputs.exists == 'true' }}
        uses: actions/download-artifact@v6
        with:
          name: build
          path: ${{ inputs.artifact_path }}

      - uses: astral-sh/setup-uv@v7
        if: ${{ success() }}
        with:
          enable-cache: true
          cache-dependency-glob: "${{ inputs.root_dir }}/uv.lock"

      - uses: actions/setup-python@v6
        if: ${{ success() && hashFiles('pyproject.toml') != '' }}
        with:
          python-version-file: "pyproject.toml"

      - name: publish to pypi
        if: ${{ success() }}
        run: uv publish
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.UV_TOKEN }}
