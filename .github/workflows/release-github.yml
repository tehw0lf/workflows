name: release artifact on github

on:
  workflow_call:
    inputs:
      runner:
        description: "workflow-runner"
        default: "ubuntu-latest"
        required: false
        type: string
      artifact_path:
        description: "path to artifact files to save from build step"
        default: ""
        required: false
        type: string
      tool:
        description: "build tool - uv, npm, etc."
        default: "none"
        required: false
        type: string
      publish_github_release:
        description: "publish github release"
        default: ""
        required: false
        type: string
      release_tag:
        description: "release tag"
        default: "latest"
        required: false
        type: string
      release_pre:
        description: "run before performing github release"
        default: ""
        required: false
        type: string
      overwrite_release:
        description: "delete existing release and recreate (enables non-semver workflows)"
        default: "false"
        required: false
        type: string

jobs:
  release_github:
    name: release artifact on github
    runs-on: ${{ inputs.runner }}
    timeout-minutes: 10
    permissions:
      actions: write
      contents: write
      packages: read
    steps:
      - name: checkout repository
        uses: actions/checkout@v6

      - name: check build artifact existence
        uses: softwareforgood/check-artifact-v4-existence@v0
        id: check_artifact_exists
        with:
          name: build

      - name: download build artifact
        if: ${{ inputs.artifact_path != '' && steps.check_artifact_exists.outputs.exists == 'true' }}
        uses: actions/download-artifact@v6
        with:
          name: build
          path: ${{ inputs.artifact_path }}

      - name: set automatic release tag for python release from pyproject.toml
        if: ${{ inputs.tool == 'uv' && steps.check_artifact_exists.outputs.exists == 'true' && hashFiles('pyproject.toml') != '' }}
        run: echo "RELEASE_TAG=v$(cat pyproject.toml | grep version | awk -F '"' '{print $2}')" >> $GITHUB_ENV

      - name: set automatic release tag for python release from version file
        if: ${{ steps.check_artifact_exists.outputs.exists == 'true' && hashFiles(format('{0}/version.json', inputs.artifact_path)) != '' }}
        run: echo "RELEASE_TAG=v$(cat ${{ inputs.artifact_path }}/version.json | grep version | awk -F '"' '{print $4}')" >> $GITHUB_ENV

      - name: use input release tag if none is set yet
        if: ${{ env.RELEASE_TAG == '' && steps.check_artifact_exists.outputs.exists == 'true' }}
        run: echo "RELEASE_TAG=${{ inputs.release_tag }}" >> $GITHUB_ENV

      - name: check if release already exists
        if: ${{ steps.check_artifact_exists.outputs.exists == 'true' }}
        id: check_release_exists
        run: |
          if gh release view ${{ env.RELEASE_TAG }} &>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            if [[ "${{ inputs.overwrite_release }}" == "true" ]]; then
              echo "::notice::[Release] Release with tag ${{ env.RELEASE_TAG }} exists, will be overwritten"
            else
              echo "::error::[Release] Release with tag ${{ env.RELEASE_TAG }} already exists"
              echo "::error::[Release] Cannot create duplicate release (set overwrite_release: true to replace)"
              exit 3
            fi
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: delete existing release if overwrite is enabled
        if: ${{ steps.check_artifact_exists.outputs.exists == 'true' && steps.check_release_exists.outputs.exists == 'true' && inputs.overwrite_release == 'true' }}
        run: |
          echo "::notice::[Release] Deleting existing release: ${{ env.RELEASE_TAG }}"
          gh release delete ${{ env.RELEASE_TAG }} --yes --cleanup-tag
          echo "::notice::[Release] Successfully deleted release and tag"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: run release pre script if present
        if: ${{ inputs.release_pre != '' && (steps.check_release_exists.outputs.exists == 'false' || inputs.overwrite_release == 'true') }}
        run: ${{ inputs.release_pre }}

      - uses: softprops/action-gh-release@v2
        if: ${{ steps.check_artifact_exists.outputs.exists == 'true' && (steps.check_release_exists.outputs.exists == 'false' || inputs.overwrite_release == 'true') }}
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: ${{ env.RELEASE_TAG }}
          name: "Release ${{ env.RELEASE_TAG }}"
          files: |
            ${{ inputs.artifact_path }}/**/*
