name: universal pipeline

on:
  workflow_call:
    secrets:
      NPM_TOKEN:
        required: false
      UV_TOKEN:
        required: false
    inputs:
      root_dir:
        description: "path to project root"
        default: "."
        required: false
        type: string
      tool:
        description: "build tool - ./gradlew || npm || yarn || mvn || uv"
        required: true
        type: string
      format:
        description: "format script to use"
        default: ""
        required: false
        type: string
      lint:
        description: "lint script to use"
        default: ""
        required: false
        type: string
      install:
        description: "install script to use"
        default: ""
        required: false
        type: string
      test:
        description: "test script to use"
        default: ""
        required: false
        type: string
      build_branch:
        description: "build script to use in branch run"
        required: true
        type: string
      build_main:
        description: "build script to use in main run"
        required: true
        type: string
      docker_namespace:
        description: "docker namespace"
        required: false
        type: string
        default: "tehw0lf"
      npm_namespace:
        description: "npm namespace"
        required: false
        type: string
        default: "@tehw0lf"
      image_name:
        description: "docker image name, will default to repository name if not set"
        required: false
        type: string
        default: ""
      registry:
        description: "registry"
        required: false
        type: string
        default: "ghcr.io"
      event_name:
        description: "github event name"
        required: true
        type: string
      docker_pre:
        description: "run before building docker image"
        default: ""
        required: false
        type: string
      libraries:
        description: "libraries to publish, separated by comma"
        default: ""
        required: false
        type: string
      library_path:
        description: "path to libraries"
        default: ""
        required: false
        type: string
      platforms:
        description: "platforms to build the docker image for, separated by comma"
        default: "linux/amd64"
        required: false
        type: string
      skip_docker:
        description: "skip docker steps"
        default: false
        required: false
        type: boolean

jobs:
  build_test_publish:
    name: build
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: write
      packages: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: configure jdk
        if: ${{ inputs.tool == './gradlew' || inputs.tool == 'mvn' }}
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"
      - uses: actions/setup-node@v4
        if: ${{ inputs.tool == 'npm' || inputs.tool == 'yarn' }}
        with:
          node-version: "20"
          cache: "${{ inputs.tool }}"
      - uses: astral-sh/setup-uv@v4
        if: ${{ inputs.tool == 'uv' }}
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"
      - uses: actions/setup-python@v5
        if: ${{ inputs.tool == 'uv' }}
        with:
          python-version-file: "pyproject.toml"
      - name: navigate to root dir
        run: cd ${{ inputs.root_dir }}
      - name: enable nx shas
        if: ${{ success() && hashFiles('./nx.json') != '' }}
        uses: nrwl/nx-set-shas@v4
        with:
          main-branch-name: main
      - name: install with npm
        if: ${{ inputs.tool == 'npm' }}
        run: npm ci
      - name: install with yarn
        if: ${{ inputs.tool == 'yarn' }}
        run: yarn install --frozen-lockfile
      - name: install with uv
        if: ${{ inputs.tool == 'uv' }}
        run: uv ${{ inputs.install }}
      - name: format
        if: ${{ inputs.format != '' }}
        run: ${{ inputs.tool }} ${{ inputs.format }}
      - name: lint
        if: ${{ inputs.lint != '' }}
        run: ${{ inputs.tool }} ${{ inputs.lint }}
      - name: test
        if: ${{ inputs.test != '' }}
        run: ${{ inputs.tool }} ${{ inputs.test }}
      - name: build on branch
        if: ${{ github.event_name != 'push' }}
        run: ${{ inputs.tool }} ${{ inputs.build_branch }}
      - name: build on main
        if: ${{ github.event_name == 'push' }}
        run: ${{ inputs.tool }} ${{ inputs.build_main }}
      - name: publish npm libraries
        if: ${{ github.event_name == 'push' && inputs.libraries != '' && inputs.library_path != '' && inputs.tool == 'npm' && success() && hashFiles(inputs.library_path) != '' && env.NPM_TOKEN != '' }}
        run: |
          echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" > .npmrc
          libraries=$(echo ${{ inputs.libraries }} | tr "," "\n")
          for library in $libraries
          do
            latest_version=$(npm view ${{ inputs.npm_namespace }}/"$library" dist-tags.latest)
            package_version=$(jq -r ".version" ${{ inputs.library_path }}/"$library"/package.json)
            if [[ "$latest_version" != "$package_version" ]]; then
              npm publish ${{ inputs.library_path }}/"$library"/ --access public --dry-run
              npm publish ${{ inputs.library_path }}/"$library"/ --access public
            fi
          done
          rm .npmrc
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
      - uses: "marvinpinto/action-automatic-releases@latest"
        if: ${{ github.event_name != 'push' && inputs.tool == 'uv' }}
        with:
          repo_token: "${{ secrets.GITHUB_TOKEN }}"
          automatic_release_tag: "latest"
          title: "Release"
          files: |
            ${{ inputs.library_path }}
      - uses: "marvinpinto/action-automatic-releases@latest"
        if: ${{ github.event_name == 'push' && inputs.tool == 'uv' }}
        with:
          repo_token: "${{ secrets.GITHUB_TOKEN }}"
          automatic_release_tag: "latest"
          prerelease: false
          title: "Release"
          files: |
            ${{ inputs.library_path }}
      - name: publish to pypi
        if: ${{ github.event_name == 'push' && inputs.tool == 'uv' && env.UV_PUBLISH_TOKEN != '' }}
        run: uv publish
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.UV_TOKEN }}
      - name: run docker pre script
        if: ${{ success() && hashFiles('./Dockerfile') != '' && inputs.docker_pre != '' && github.event_name == 'push' && inputs.skip_docker == false }}}
        run: ${{ inputs.docker_pre }}
      - name: set up docker
        if: ${{ success() && hashFiles('./Dockerfile') != '' && github.event_name == 'push' && inputs.skip_docker == false }}
        uses: docker/setup-buildx-action@v3
      - name: login
        if: ${{ success() && hashFiles('./Dockerfile') != '' && github.event_name == 'push' && inputs.skip_docker == false }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: set docker image name
        if: ${{ success() && hashFiles('./Dockerfile') != '' && github.event_name == 'push' && inputs.skip_docker == false }}
        id: set_docker_image_name
        run: |
          DOCKER_IMAGE_NAME="${{ inputs.image_name }}"
          echo "image_name=${DOCKER_IMAGE_NAME:-${{ github.event.repository.name }}}" >> $GITHUB_OUTPUT
      - name: build and push image
        if: ${{ success() && hashFiles('./Dockerfile') != '' && github.event_name == 'push' && inputs.skip_docker == false }}
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          platforms: ${{ inputs.platforms }}
          tags: ${{ inputs.registry }}/${{ inputs.docker_namespace }}/${{ steps.set_docker_image_name.outputs.image_name }}:latest
