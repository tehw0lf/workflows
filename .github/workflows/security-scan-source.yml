name: security scan source

on:
  workflow_call:
    inputs:
      root_dir:
        description: "path to project root"
        default: "."
        required: false
        type: string
      tool:
        description: "build tool - ./gradlew || npm || yarn || mvn || uv || bash"
        default: "none"
        required: false
        type: string
      runner:
        description: "workflow-runner"
        default: "ubuntu-latest"
        required: false
        type: string
      semgrep_rules:
        description: "semgrep ruleset (auto, p/security-audit, p/owasp-top-ten, p/ci, etc.)"
        default: "auto"
        required: false
        type: string
    outputs:
      semgrep_result:
        description: "semgrep scan result"
        value: ${{ jobs.scan_source.outputs.semgrep_result }}
      bandit_result:
        description: "bandit scan result"
        value: ${{ jobs.scan_source.outputs.bandit_result }}
      npm_audit_result:
        description: "npm audit result"
        value: ${{ jobs.scan_source.outputs.npm_audit_result }}
      pip_audit_result:
        description: "pip-audit result"
        value: ${{ jobs.scan_source.outputs.pip_audit_result }}

jobs:
  scan_source:
    name: scan source code and dependencies
    runs-on: ${{ inputs.runner }}
    timeout-minutes: 15
    permissions:
      contents: read
      security-events: write
      actions: read
    outputs:
      semgrep_result: ${{ steps.semgrep-check.outcome }}
      bandit_result: ${{ steps.bandit.outcome }}
      npm_audit_result: ${{ steps.npm-audit.outcome }}
      pip_audit_result: ${{ steps.pip-audit.outcome }}
    defaults:
      run:
        working-directory: ${{ inputs.root_dir }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      # Setup Python once for all tools (Semgrep, Bandit, pip-audit)
      - name: setup python (from pyproject.toml for uv, 3.12 otherwise)
        uses: actions/setup-python@v6
        with:
          python-version: ${{ inputs.tool == 'uv' && '' || '3.12' }}
          python-version-file: ${{ inputs.tool == 'uv' && format('{0}/pyproject.toml', inputs.root_dir) || '' }}

      # Layer 1a: Semgrep SAST (all languages)
      - name: install semgrep
        run: pip install semgrep

      - name: semgrep security scan
        id: semgrep
        run: semgrep ci --config=${{ inputs.semgrep_rules }} --sarif > semgrep.sarif
        continue-on-error: true

      - name: check semgrep results for unsuppressed findings
        id: semgrep-check
        if: always()
        run: |
          # Check if semgrep.sarif exists and has findings
          if [ ! -f semgrep.sarif ]; then
            echo "No SARIF file generated, failing..."
            exit 1
          fi

          # Extract findings that are NOT suppressed
          unsuppressed_count=$(jq '[.runs[].results[] | select(.suppressions == null or .suppressions == [])] | length' semgrep.sarif)
          total_count=$(jq '[.runs[].results[]] | length' semgrep.sarif)
          suppressed_count=$((total_count - unsuppressed_count))

          echo "Total findings: $total_count"
          echo "Suppressed findings: $suppressed_count"
          echo "Unsuppressed findings: $unsuppressed_count"

          if [ "$unsuppressed_count" -gt 0 ]; then
            echo "❌ Found $unsuppressed_count unsuppressed security findings that must be fixed"
            exit 1
          elif [ "$suppressed_count" -gt 0 ]; then
            echo "✅ All $suppressed_count findings are suppressed with nosemgrep comments"
            exit 0
          else
            echo "✅ No security findings detected"
            exit 0
          fi

      - name: upload semgrep SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: semgrep.sarif
        continue-on-error: true

      # Layer 1b: Python-specific scanning
      - name: install bandit
        if: ${{ inputs.tool == 'uv' }}
        run: pip install bandit[toml]

      - name: bandit python SAST
        id: bandit
        if: ${{ inputs.tool == 'uv' }}
        run: |
          bandit -r . -f json -o bandit-report.json || true
          bandit -r . --exit-zero --severity-level medium
        continue-on-error: false

      - name: pip-audit dependency scan
        if: ${{ inputs.tool == 'uv' }}
        id: pip-audit
        uses: pypa/gh-action-pip-audit@v1.1.0
        with:
          inputs: requirements.txt
        continue-on-error: false

      # Layer 1c: Node.js-specific scanning
      - name: setup node for npm scanning
        if: ${{ inputs.tool == 'npm' || inputs.tool == 'yarn' }}
        uses: actions/setup-node@v6
        with:
          node-version: "24.12.0"
          cache: "${{ inputs.tool }}"
          cache-dependency-path: |
            ${{ inputs.root_dir }}/package-lock.json
            ${{ inputs.root_dir }}/yarn.lock

      - name: npm audit
        id: npm-audit
        if: ${{ inputs.tool == 'npm' }}
        run: npm audit --audit-level=moderate
        continue-on-error: false

      - name: yarn audit
        id: yarn-audit
        if: ${{ inputs.tool == 'yarn' }}
        run: yarn audit --level moderate
        continue-on-error: false

      - name: upload security scan reports
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: security-scan-source-reports
          path: |
            ${{ inputs.root_dir }}/bandit-report.json
            ${{ inputs.root_dir }}/semgrep.sarif
          if-no-files-found: ignore
