name: summarize workflow results

on:
  workflow_call:
    inputs:
      test_and_build_result:
        description: "Result of test and build job"
        required: true
        type: string
      security_scan_source_result:
        description: "Result of pre-build security scanning"
        required: true
        type: string
      security_scan_artifacts_result:
        description: "Result of post-build security scanning"
        required: true
        type: string
      publish_docker_image_result:
        description: "Result of docker image publishing"
        required: true
        type: string
      publish_npm_libraries_result:
        description: "Result of npm libraries publishing"
        required: true
        type: string
      publish_python_libraries_result:
        description: "Result of python libraries publishing"
        required: true
        type: string
      publish_firefox_extension_result:
        description: "Result of firefox extension publishing"
        required: true
        type: string
      release_android_apk_result:
        description: "Result of android apk release"
        required: true
        type: string
      release_github_result:
        description: "Result of github release"
        required: true
        type: string
    outputs:
      artifacts:
        description: "List of published artifacts"
        value: ${{ jobs.summarize.outputs.artifacts }}

jobs:
  summarize:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      actions: read
    outputs:
      artifacts: ${{ steps.summary.outputs.artifacts }}
    steps:
      - name: Generate workflow summary
        id: summary
        run: |
          # Function to get status emoji and text
          get_status() {
            case "$1" in
              success) echo "âœ… $2" ;;
              failure) echo "âŒ Failed" ;;
              cancelled) echo "ðŸš« Cancelled" ;;
              skipped) echo "â­ï¸ Skipped" ;;
              *) echo "â“ Unknown" ;;
            esac
          }

          # Function to add job row to summary
          add_job_row() {
            local job_name="$1"
            local status="$2"
            local success_text="${3:-Success}"
            local artifact_id="$4"

            local status_text=$(get_status "$status" "$success_text")
            echo "| $job_name | $status_text |" >> $GITHUB_STEP_SUMMARY

            # Track artifact if successful and artifact_id provided
            if [[ "$status" == "success" && -n "$artifact_id" ]]; then
              echo "$artifact_id"
            fi
          }

          echo "## Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY

          # Collect artifacts from successful jobs
          artifacts=()

          # Security Scanning (no artifact tracking)
          add_job_row "ðŸ”’ Security Scan (Source)" "${{ inputs.security_scan_source_result }}" "Passed"
          add_job_row "ðŸ”’ Security Scan (Artifacts)" "${{ inputs.security_scan_artifacts_result }}" "Passed"

          # Build & Test (no artifact tracking)
          add_job_row "Build & Test" "${{ inputs.test_and_build_result }}" "Success"

          # Publishing jobs (track artifacts)
          result=$(add_job_row "Docker Images" "${{ inputs.publish_docker_image_result }}" "Published" "docker")
          [[ -n "$result" ]] && artifacts+=("$result")

          result=$(add_job_row "NPM Libraries" "${{ inputs.publish_npm_libraries_result }}" "Published" "npm")
          [[ -n "$result" ]] && artifacts+=("$result")

          result=$(add_job_row "Python Libraries" "${{ inputs.publish_python_libraries_result }}" "Published" "python")
          [[ -n "$result" ]] && artifacts+=("$result")

          result=$(add_job_row "Firefox Extension" "${{ inputs.publish_firefox_extension_result }}" "Published" "firefox")
          [[ -n "$result" ]] && artifacts+=("$result")

          result=$(add_job_row "Android APK" "${{ inputs.release_android_apk_result }}" "Released" "android")
          [[ -n "$result" ]] && artifacts+=("$result")

          result=$(add_job_row "GitHub Release" "${{ inputs.release_github_result }}" "Created" "github")
          [[ -n "$result" ]] && artifacts+=("$result")

          # Convert artifacts array to JSON
          if [ ${#artifacts[@]} -eq 0 ]; then
            artifacts_json="[]"
          else
            artifacts_json=$(printf '%s\n' "${artifacts[@]}" | jq -R . | jq -sc .)
          fi
          echo "artifacts=$artifacts_json" >> $GITHUB_OUTPUT