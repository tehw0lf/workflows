name: post-publish verification

on:
  workflow_call:
    inputs:
      docker_meta:
        description: "docker metadata as json array ([{'name':'docker-image-name','file':'docker/app/Dockerfile'}])"
        default: ""
        required: false
        type: string
      registry:
        description: "registry"
        required: false
        type: string
        default: "ghcr.io"
      docker_namespace:
        description: "docker namespace"
        required: false
        type: string
        default: "tehw0lf"
      platforms:
        description: "platforms to scan (e.g., 'linux/amd64,linux/arm64')"
        default: "linux/amd64"
        required: false
        type: string
      runner:
        description: "workflow-runner"
        default: "ubuntu-latest"
        required: false
        type: string
      trivy_severity:
        description: "minimum severity level for trivy (UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL)"
        default: "MEDIUM,HIGH,CRITICAL"
        required: false
        type: string
      trivy_exit_code:
        description: "exit code when vulnerabilities are found (0=continue, 1=fail)"
        default: "1"
        required: false
        type: string
    outputs:
      trivy_image_result:
        description: "trivy image scan result"
        value: ${{ jobs.verify_published_images.outputs.trivy_image_result }}

jobs:
  verify_published_images:
    name: verify published docker images
    runs-on: ${{ inputs.runner }}
    timeout-minutes: 20
    permissions:
      contents: read
      security-events: write
      packages: read
    outputs:
      trivy_image_result: ${{ steps.trivy-image.outcome }}
    steps:
      # Authenticate to GHCR for pulling images
      - name: log in to GitHub Container Registry
        if: ${{ inputs.registry == 'ghcr.io' && inputs.docker_meta != '' }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}

      # Install Trivy with caching
      - name: cache trivy installation
        id: cache-trivy
        if: ${{ inputs.docker_meta != '' }}
        uses: actions/cache@v5
        with:
          path: |
            /usr/local/bin/trivy
            ~/.cache/trivy
          key: ${{ runner.os }}-trivy-${{ hashFiles('**/post-publish-verification.yml') }}
          restore-keys: |
            ${{ runner.os }}-trivy-

      - name: install trivy
        if: ${{ inputs.docker_meta != '' && steps.cache-trivy.outputs.cache-hit != 'true' }}
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin v0.58.2

      # Extract image names from docker_meta
      - name: extract docker image names
        id: docker-images
        if: ${{ inputs.docker_meta != '' }}
        run: |
          images=$(echo '${{ inputs.docker_meta }}' | jq -r '.[].name' | while read -r name; do echo "${{ inputs.registry }}/${{ inputs.docker_namespace }}/$name:latest"; done | paste -sd "," -)
          echo "images=$images" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Images to scan: $images"

      # Scan each published Docker image
      - name: trivy image scan
        id: trivy-image
        if: ${{ steps.docker-images.outputs.images != '' }}
        run: |
          IFS=',' read -ra IMAGE_ARRAY <<< "${{ steps.docker-images.outputs.images }}"
          IFS=',' read -ra PLATFORM_ARRAY <<< "${{ inputs.platforms }}"
          exit_code=0

          for image in "${IMAGE_ARRAY[@]}"; do
            echo "ðŸ” Scanning $image..."

            # Pull the image first to ensure it's available (try each platform)
            pulled=false
            for platform in "${PLATFORM_ARRAY[@]}"; do
              if docker pull --platform "$platform" "$image" 2>/dev/null; then
                pulled=true
                break
              fi
            done

            # Fallback to platform-agnostic pull
            if [ "$pulled" = false ]; then
              docker pull "$image" || { echo "âŒ Failed to pull $image"; exit_code=1; continue; }
            fi

            # Create sanitized filename (replace : and / with -)
            sanitized_name=$(echo "${image}" | tr ':/' '--')

            # Run Trivy scan
            trivy image \
              --format sarif \
              --output "trivy-image-${sanitized_name}.sarif" \
              --severity "${{ inputs.trivy_severity }}" \
              --exit-code "${{ inputs.trivy_exit_code }}" \
              "$image" || exit_code=$?

            # Generate human-readable table
            echo "### ðŸ” Trivy Image Scan Results: $image" >> $GITHUB_STEP_SUMMARY
            trivy image \
              --format table \
              --severity "${{ inputs.trivy_severity }}" \
              "$image" >> $GITHUB_STEP_SUMMARY || true
            echo "" >> $GITHUB_STEP_SUMMARY
          done

          exit $exit_code
        continue-on-error: false

      # Upload SARIF results to GitHub Security
      - name: upload trivy image SARIF
        if: always() && steps.trivy-image.outcome != 'skipped'
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-image-*.sarif
          category: trivy-published-images
        continue-on-error: true

      # Upload scan reports as artifacts
      - name: upload security scan reports
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: post-publish-verification-reports
          path: trivy-image-*.sarif
          if-no-files-found: ignore
