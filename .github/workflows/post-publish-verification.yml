name: post-publish verification

on:
  workflow_call:
    inputs:
      docker_meta:
        description: "docker metadata as json array ([{'name':'docker-image-name','file':'docker/app/Dockerfile'}])"
        default: ""
        required: false
        type: string
      registry:
        description: "registry"
        required: false
        type: string
        default: "ghcr.io"
      docker_namespace:
        description: "docker namespace"
        required: false
        type: string
        default: "tehw0lf"
      runner:
        description: "workflow-runner"
        default: "ubuntu-latest"
        required: false
        type: string
      trivy_severity:
        description: "minimum severity level for trivy (UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL)"
        default: "MEDIUM,HIGH,CRITICAL"
        required: false
        type: string
      trivy_exit_code:
        description: "exit code when vulnerabilities are found (0=continue, 1=fail)"
        default: "1"
        required: false
        type: string
    outputs:
      trivy_image_result:
        description: "trivy image scan result"
        value: ${{ jobs.verify_published_images.outputs.trivy_image_result }}

jobs:
  verify_published_images:
    name: verify published docker images
    runs-on: ${{ inputs.runner }}
    timeout-minutes: 20
    permissions:
      contents: read
      security-events: write
      packages: read
    outputs:
      trivy_image_result: ${{ steps.trivy-image.outcome }}
    steps:
      # Authenticate to GHCR for pulling images
      - name: log in to GitHub Container Registry
        if: ${{ inputs.registry == 'ghcr.io' && inputs.docker_meta != '' }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}

      # Extract image names from docker_meta
      - name: extract docker image names
        id: docker-images
        if: ${{ inputs.docker_meta != '' }}
        run: |
          images=$(echo '${{ inputs.docker_meta }}' | jq -r '.[].name' | while read -r name; do echo "${{ inputs.registry }}/${{ inputs.docker_namespace }}/$name:latest"; done | paste -sd "," -)
          echo "images=$images" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Images to scan: $images"

      # Scan each published Docker image
      - name: trivy image scan
        id: trivy-image
        if: ${{ steps.docker-images.outputs.images != '' }}
        run: |
          IFS=',' read -ra IMAGE_ARRAY <<< "${{ steps.docker-images.outputs.images }}"
          exit_code=0

          for image in "${IMAGE_ARRAY[@]}"; do
            echo "ðŸ” Scanning $image..."

            # Pull the image first to ensure it's available (multi-platform support)
            docker pull --platform linux/amd64 "$image" 2>/dev/null || \
            docker pull --platform linux/arm64 "$image" 2>/dev/null || \
            docker pull "$image" || { echo "âŒ Failed to pull $image"; exit_code=1; continue; }

            # Run Trivy scan
            trivy image \
              --format sarif \
              --output "trivy-image-${image##*/}.sarif" \
              --severity "${{ inputs.trivy_severity }}" \
              --exit-code "${{ inputs.trivy_exit_code }}" \
              "$image" || exit_code=$?

            # Generate human-readable table
            echo "### ðŸ” Trivy Image Scan Results: $image" >> $GITHUB_STEP_SUMMARY
            trivy image \
              --format table \
              --severity "${{ inputs.trivy_severity }}" \
              "$image" >> $GITHUB_STEP_SUMMARY || true
            echo "" >> $GITHUB_STEP_SUMMARY
          done

          exit $exit_code
        continue-on-error: false

      # Upload SARIF results to GitHub Security
      - name: upload trivy image SARIF
        if: always() && steps.trivy-image.outcome != 'skipped'
        run: |
          # Find all SARIF files and upload them
          for sarif_file in trivy-image-*.sarif; do
            if [ -f "$sarif_file" ]; then
              echo "ðŸ“¤ Uploading $sarif_file"
              gh api \
                --method POST \
                -H "Accept: application/vnd.github+json" \
                /repos/${{ github.repository }}/code-scanning/sarifs \
                -f sarif="@$sarif_file" \
                -f commit_sha="${{ github.sha }}" \
                -f ref="${{ github.ref }}" || true
            fi
          done
        env:
          GITHUB_TOKEN: ${{ github.token }}
        continue-on-error: true

      # Upload scan reports as artifacts
      - name: upload security scan reports
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: post-publish-verification-reports
          path: trivy-image-*.sarif
          if-no-files-found: ignore
