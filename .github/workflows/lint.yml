name: Lint Workflows

on:
  workflow_call:

jobs:
  actionlint:
    name: Validate GitHub Actions workflows
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: write  # Needed to push validated hash to workflows repository
    steps:
      - name: Checkout workflow repository
        uses: actions/checkout@v5
        with:
          repository: tehw0lf/workflows
          ref: main
          path: workflows-repo

      - name: Generate workflow hash for cache key
        id: workflow-hash
        run: |
          cd workflows-repo/.github
          HASH=$( (find workflows -type f \( -name '*.yml' -o -name '*.yaml' \); find . -maxdepth 1 -name 'actionlint.yaml') | sort | xargs sha256sum | sha256sum | cut -d' ' -f1)
          echo "hash=$HASH" >> $GITHUB_OUTPUT
          echo "::notice::[Lint] Workflow hash: $HASH"

      - name: Check cross-repository validation cache
        id: cross-repo-cache
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          HASH="${{ steps.workflow-hash.outputs.hash }}"

          # Check if validated hash file exists in the workflows repository
          # NOTE: Stored outside .github/ to avoid being included in hash calculation
          CACHED_HASH=$(cat workflows-repo/.validated-hash 2>/dev/null || echo "")

          if [ "$CACHED_HASH" = "$HASH" ]; then
            echo "::notice::[Lint] Validation cache hit (cross-repository cache from workflows repo)"
            echo "cache-hit=true" >> $GITHUB_OUTPUT
          else
            echo "::notice::[Lint] Hash not found in cross-repository cache"
            echo "cache-hit=false" >> $GITHUB_OUTPUT
          fi

      - name: Check local validation cache
        if: steps.cross-repo-cache.outputs.cache-hit != 'true'
        id: local-cache
        uses: actions/cache@v4
        with:
          path: .actionlint-cache
          key: actionlint-validation-${{ steps.workflow-hash.outputs.hash }}

      - name: Install actionlint
        if: steps.cross-repo-cache.outputs.cache-hit != 'true' && steps.local-cache.outputs.cache-hit != 'true'
        run: |
          bash <(curl -fsSL https://raw.githubusercontent.com/rhysd/actionlint/main/scripts/download-actionlint.bash)
          sudo mv actionlint /usr/local/bin/

      - name: Run actionlint
        if: steps.cross-repo-cache.outputs.cache-hit != 'true' && steps.local-cache.outputs.cache-hit != 'true'
        run: |
          cd workflows-repo
          actionlint -color -config-file .github/actionlint.yaml .github/workflows/*.yml

      - name: Create local cache marker
        if: steps.cross-repo-cache.outputs.cache-hit != 'true' && steps.local-cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p .actionlint-cache
          echo "Validated at $(date -u +"%Y-%m-%d %H:%M:%S UTC")" > .actionlint-cache/validated
          echo "Hash: ${{ steps.workflow-hash.outputs.hash }}" >> .actionlint-cache/validated

      - name: Update cross-repository cache
        if: steps.cross-repo-cache.outputs.cache-hit != 'true' && steps.local-cache.outputs.cache-hit != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          HASH="${{ steps.workflow-hash.outputs.hash }}"

          cd workflows-repo

          # Write hash to cache file (outside .github/ to avoid hash calculation loop)
          echo "$HASH" > .validated-hash

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Commit and push if changed
          if ! git diff --quiet .validated-hash; then
            git add .validated-hash
            git commit -m "chore(lint): update validated workflow hash [skip ci]"
            git push origin main
            echo "::notice::[Lint] Updated cross-repository cache in workflows repository"
          else
            echo "::notice::[Lint] Cross-repository cache already up to date"
          fi

      - name: Workflow validation summary
        run: |
          if [ "${{ steps.cross-repo-cache.outputs.cache-hit }}" = "true" ]; then
            echo "✅ Workflow validation passed (cross-repository cache)"
            echo "::notice::[Lint] Validation result retrieved from cross-repository cache"
          elif [ "${{ steps.local-cache.outputs.cache-hit }}" = "true" ]; then
            echo "✅ Workflow validation passed (local cache)"
            echo "::notice::[Lint] Validation result retrieved from local cache"
          else
            echo "✅ All workflows passed actionlint validation"
            echo "::notice::[Lint] Validation completed and cached for future runs"
          fi
