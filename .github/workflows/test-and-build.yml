name: test and build

on:
  workflow_call:
    inputs:
      root_dir:
        description: "path to project root"
        default: "."
        required: false
        type: string
      tool:
        description: "build tool - ./gradlew || npm || yarn || mvn || uv || bash"
        default: "none"
        required: false
        type: string
      format:
        description: "format script to use"
        default: ""
        required: false
        type: string
      lint:
        description: "lint script to use"
        default: ""
        required: false
        type: string
      install:
        description: "install script to use"
        default: ""
        required: false
        type: string
      test:
        description: "test script to use"
        default: ""
        required: false
        type: string
      e2e:
        description: "e2e test script to use"
        default: ""
        required: false
        type: string
      build_branch:
        description: "build script to use in branch run"
        default: ""
        required: false
        type: string
      build_main:
        description: "build script to use in main run"
        default: ""
        required: false
        type: string
      post_build_script:
        description: "build script to use in main run"
        default: ""
        required: false
        type: string
      artifact_path:
        description: "path to artifact files to save from build step"
        default: ""
        required: false
        type: string
      runner:
        description: "workflow-runner"
        default: "ubuntu-latest"
        required: false
        type: string
      app_root:
        description: "app root"
        default: ""
        required: false
        type: string
      rust_version:
        description: "rust toolchain version"
        default: "stable"
        required: false
        type: string
      enable_clippy:
        description: "run clippy linting for rust projects"
        default: true
        required: false
        type: boolean
      enable_rustfmt:
        description: "run rustfmt checks for rust projects"
        default: true
        required: false
        type: boolean
      clippy_args:
        description: "additional clippy arguments"
        default: "-- -D warnings"
        required: false
        type: string
      cargo_features:
        description: "cargo features to enable (e.g., 'async,network')"
        default: ""
        required: false
        type: string
      enable_sbom_attestation:
        description: "enable SBOM generation and attestation"
        required: false
        type: string
        default: "true"
      sbom_format:
        description: "SBOM format - spdx or cyclonedx"
        required: false
        type: string
        default: "cyclonedx"
      cyclonedx_ignore_npm_errors:
        description: "Use --package-lock-only flag for SBOM generation (avoids npm ls validation issues with overrides)"
        required: false
        type: boolean
        default: false

jobs:
  test_and_build:
    name: test and build
    runs-on: ${{ inputs.runner }}
    timeout-minutes: 45
    permissions:
      actions: write
      contents: read
      packages: read
    defaults:
      run:
        working-directory: ${{ inputs.root_dir }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: cache dependencies
        uses: actions/cache@v5
        with:
          path: |
            ~/.npm
            ~/.yarn/cache
            ~/.cache/pip
            ~/.cache/uv
            ~/.gradle/caches
            ~/.gradle/wrapper
            ~/.m2/repository
          key: deps-${{ inputs.tool }}-${{ runner.os }}-${{ hashFiles('**/package-lock.json', '**/yarn.lock', '**/uv.lock', '**/gradle.properties', '**/pom.xml') }}
          restore-keys: |
            deps-${{ inputs.tool }}-${{ runner.os }}-
            deps-${{ inputs.tool }}-

      - name: configure jdk
        if: ${{ inputs.tool == './gradlew' || inputs.tool == 'mvn' }}
        uses: actions/setup-java@v5
        with:
          distribution: "temurin"
          java-version: "21"

      - uses: actions/setup-node@v6
        if: ${{ inputs.tool == 'npm' || inputs.tool == 'yarn' }}
        with:
          node-version: "24.12.0"
          cache: "${{ inputs.tool }}"
          cache-dependency-path: |
            ${{ inputs.root_dir }}/package-lock.json
            ${{ inputs.root_dir }}/yarn.lock
            ${{ inputs.root_dir }}/pnpm-lock.yaml

      - uses: astral-sh/setup-uv@v7
        if: ${{ inputs.tool == 'uv' }}
        with:
          enable-cache: true
          cache-dependency-glob: "${{ inputs.root_dir }}/uv.lock"

      - uses: actions/setup-python@v6
        if: ${{ inputs.tool == 'uv' }}
        with:
          python-version-file: "${{ inputs.root_dir }}/pyproject.toml"

      - name: install rust toolchain
        if: ${{ inputs.tool == 'cargo' }}
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ inputs.rust_version }}
          components: ${{ inputs.enable_rustfmt == true && 'rustfmt' || '' }}${{ inputs.enable_clippy == true && inputs.enable_rustfmt == true && ',clippy' || inputs.enable_clippy == true && 'clippy' || '' }}

      - name: cache cargo dependencies
        if: ${{ inputs.tool == 'cargo' }}
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: deps-cargo-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            deps-cargo-${{ runner.os }}-

      - name: enable nx shas
        if: ${{ success() && hashFiles('./nx.json') != '' }}
        uses: nrwl/nx-set-shas@v4
        with:
          main-branch-name: main

      - name: install with npm
        if: ${{ inputs.tool == 'npm' }}
        run: npm ci

      - name: install with yarn
        if: ${{ inputs.tool == 'yarn' }}
        run: yarn install --frozen-lockfile

      - name: install with ${{ inputs.tool }}
        if: ${{ inputs.tool != 'none' && inputs.tool != 'npm' && inputs.tool != 'yarn' }}
        run: ${{ inputs.tool }} ${{ inputs.install }}

      - name: generate SBOM
        if: ${{ inputs.enable_sbom_attestation == 'true' && (inputs.tool == 'npm' || inputs.tool == 'yarn') }}
        run: |
          echo "::notice::[SBOM] Generating SBOM in $SBOM_FORMAT format"

          # Create SBOM directory
          mkdir -p sbom

          # Generate SBOM using CycloneDX tool
          if [ "${{ inputs.cyclonedx_ignore_npm_errors }}" = "true" ]; then
            echo "::notice::[SBOM] Using --ignore-npm-errors flag"
            npx @cyclonedx/cyclonedx-npm --ignore-npm-errors --output-file sbom/sbom.cyclonedx.json --spec-version 1.7 --output-format JSON
          else
            npx @cyclonedx/cyclonedx-npm --output-file sbom/sbom.cyclonedx.json --spec-version 1.7 --output-format JSON
          fi

          echo "::notice::[SBOM] SBOM generated successfully"
        env:
          TOOL: ${{ inputs.tool }}
          SBOM_FORMAT: ${{ inputs.sbom_format }}

      - name: attest SBOM
        if: ${{ inputs.enable_sbom_attestation == 'true' && (inputs.tool == 'npm' || inputs.tool == 'yarn') }}
        uses: actions/attest-sbom@v3
        with:
          subject-path: |
            ${{ inputs.root_dir }}/sbom/sbom.*.json
          sbom-path: |
            ${{ inputs.root_dir }}/sbom/sbom.*.json

      - name: upload SBOM artifact
        if: ${{ inputs.enable_sbom_attestation == 'true' && (inputs.tool == 'npm' || inputs.tool == 'yarn') }}
        uses: actions/upload-artifact@v6
        with:
          name: sbom-npm-libraries
          path: ${{ inputs.root_dir }}/sbom/
          retention-days: 90
          if-no-files-found: warn

      - name: format
        if: ${{ inputs.tool != 'none' && inputs.format != '' }}
        run: ${{ inputs.tool }} ${{ inputs.format }}

      - name: lint
        if: ${{ inputs.tool != 'none' && inputs.lint != '' }}
        run: ${{ inputs.tool }} ${{ inputs.lint }}

      - name: test
        if: ${{ inputs.tool != 'none' && inputs.test != '' }}
        run: ${{ inputs.tool }} ${{ inputs.test }}

      - name: Cache Playwright browsers
        if: ${{ (inputs.tool == 'npm' || inputs.tool == 'yarn') && inputs.e2e != '' && (hashFiles('**/**/playwright.config.ts') != '' || hashFiles('**/**/playwright.config.js') != '' || hashFiles('**/**/playwright.config.mjs') != '')}}
        id: playwright-cache
        uses: actions/cache@v5
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('**/package-lock.json', '**/yarn.lock') }}

      - name: Install Playwright browsers and dependencies
        if: ${{ (inputs.tool == 'npm' || inputs.tool == 'yarn') && inputs.e2e != '' && (hashFiles('**/**/playwright.config.ts') != '' || hashFiles('**/**/playwright.config.js') != '' || hashFiles('**/**/playwright.config.mjs') != '')}}
        run: |
          npx playwright install --with-deps
        env:
          PLAYWRIGHT_BROWSERS_PATH: ~/.cache/ms-playwright

      - name: e2e test
        if: ${{ inputs.tool != 'none' && inputs.e2e != '' }}
        run: ${{ inputs.tool }} ${{ inputs.e2e }}

      - name: run rustfmt
        if: ${{ inputs.tool == 'cargo' && inputs.enable_rustfmt == true }}
        run: cargo fmt --all -- --check

      - name: run clippy
        if: ${{ inputs.tool == 'cargo' && inputs.enable_clippy == true }}
        run: |
          if [[ -n "$CARGO_FEATURES" ]]; then
            cargo clippy --all-targets --features "$CARGO_FEATURES" $CLIPPY_ARGS
          else
            cargo clippy --all-targets --all-features $CLIPPY_ARGS
          fi
        env:
          CARGO_FEATURES: ${{ inputs.cargo_features }}
          CLIPPY_ARGS: ${{ inputs.clippy_args }}

      - name: run cargo tests
        if: ${{ inputs.tool == 'cargo' }}
        run: |
          if [[ -n "$CARGO_FEATURES" ]]; then
            cargo test --features "$CARGO_FEATURES"
          else
            cargo test --all-features
          fi
        env:
          CARGO_FEATURES: ${{ inputs.cargo_features }}

      - name: build cargo release
        if: ${{ inputs.tool == 'cargo' }}
        run: |
          if [[ -n "$CARGO_FEATURES" ]]; then
            cargo build --release --features "$CARGO_FEATURES"
          else
            cargo build --release
          fi
        env:
          CARGO_FEATURES: ${{ inputs.cargo_features }}

      - name: build on branch
        if: ${{ github.event_name != 'push' && inputs.tool != 'none' && inputs.build_branch != '' }}
        run: ${{ inputs.tool }} ${{ inputs.build_branch }}

      - name: build on main
        if: ${{ github.event_name == 'push' && inputs.tool != 'none' && inputs.build_main != '' }}
        run: ${{ inputs.tool }} ${{ inputs.build_main }}

      - name: post build script on main
        if: ${{ github.event_name == 'push' && inputs.tool != 'none' && inputs.post_build_script != '' }}
        run: ${{ inputs.tool }} ${{ inputs.post_build_script }}

      - name: upload build artifact (from artifact_path)
        if: ${{ github.event_name == 'push' && inputs.artifact_path != '' }}
        uses: actions/upload-artifact@v6
        with:
          name: build
          path: ${{ inputs.root_dir }}/${{ inputs.artifact_path }}

      - name: upload app artifact (from app_root)
        if: ${{ github.event_name == 'push' && inputs.app_root != '' }}
        uses: actions/upload-artifact@v6
        with:
          name: app
          path: ${{ inputs.app_root }}
