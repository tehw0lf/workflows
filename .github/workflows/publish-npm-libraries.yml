name: publish npm libraries

on:
  workflow_call:
    inputs:
      root_dir:
        description: "path to project root"
        default: "."
        required: false
        type: string
      runner:
        description: "workflow-runner"
        default: "ubuntu-latest"
        required: false
        type: string
      artifact_path:
        description: "path to artifact files to save from build step"
        default: ""
        required: false
        type: string
      tool:
        description: "build tool - npm or yarn"
        default: "none"
        required: false
        type: string
      libraries:
        description: "libraries to publish, separated by comma"
        default: ""
        required: false
        type: string
      library_path:
        description: "path to libraries"
        default: ""
        required: false
        type: string
      npm_namespace:
        description: "npm namespace"
        required: false
        type: string
        default: "@tehw0lf"
      n8n_verifiable_node:
        description: "whether this is a verifiable n8n node release"
        required: false
        type: string
        default: "true"
      enable_sbom_attestation:
        description: "enable SBOM generation and attestation"
        required: false
        type: string
        default: "true"
      sbom_format:
        description: "SBOM format - spdx or cyclonedx"
        required: false
        type: string
        default: "spdx"

jobs:
  publish_npm_libraries:
    name: publish npm libraries
    runs-on: ${{ inputs.runner }}
    timeout-minutes: 20
    permissions:
      actions: read
      contents: write
      packages: read
      id-token: write
    defaults:
      run:
        working-directory: ${{ inputs.root_dir }}
    steps:
      - uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: check build artifact existence
        uses: softwareforgood/check-artifact-v4-existence@v0
        id: check_artifact_exists
        with:
          name: build

      - name: download build artifact
        if: ${{ inputs.artifact_path != '' && steps.check_artifact_exists.outputs.exists == 'true' }}
        uses: actions/download-artifact@v7
        with:
          name: build
          path: ${{ inputs.artifact_path }}

      - uses: actions/setup-node@v6
        if: ${{ inputs.tool == 'npm' || inputs.tool == 'yarn' }}
        with:
          node-version: "24.12.0"
          registry-url: "https://registry.npmjs.org"
          cache: "${{ inputs.tool }}"
          cache-dependency-path: |
            ${{ inputs.root_dir }}/package-lock.json
            ${{ inputs.root_dir }}/yarn.lock
            ${{ inputs.root_dir }}/pnpm-lock.yaml

      - name: install latest npm for OIDC support
        run: npm install -g npm@latest

      - name: install @n8n/node-cli
        if: ${{ inputs.tool == 'npm' && startsWith(github.repository, format('{0}/n8n-nodes', github.repository_owner)) && inputs.n8n_verifiable_node == 'true' }}
        run: npm install -g @n8n/node-cli

      - name: install dependencies for n8n release
        if: ${{ inputs.tool == 'npm' && startsWith(github.repository, format('{0}/n8n-nodes', github.repository_owner)) && inputs.n8n_verifiable_node == 'true' }}
        run: npm ci

      - name: publish n8n node
        if: ${{ inputs.tool == 'npm' && startsWith(github.repository, format('{0}/n8n-nodes', github.repository_owner)) && inputs.n8n_verifiable_node == 'true' }}
        run: |
          echo "::notice::[NPM] Publishing n8n node"

          # Configure git with the commit author's information from env (set safely below)
          echo "::notice::[GIT] Configuring git as: $COMMIT_AUTHOR_NAME <$COMMIT_AUTHOR_EMAIL>"
          git config user.name "$COMMIT_AUTHOR_NAME"
          git config user.email "$COMMIT_AUTHOR_EMAIL"

          n8n-node release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMIT_AUTHOR_NAME: ${{ github.event.head_commit.author.name || 'github-actions[bot]' }}
          COMMIT_AUTHOR_EMAIL: ${{ github.event.head_commit.author.email || 'github-actions[bot]@users.noreply.github.com' }}

      - name: publish multiple npm libraries
        if: ${{ inputs.libraries != '' && steps.check_artifact_exists.outputs.exists == 'true' && (!startsWith(github.repository, format('{0}/n8n-nodes', github.repository_owner)) || (startsWith(github.repository, format('{0}/n8n-nodes', github.repository_owner)) && inputs.n8n_verifiable_node != 'true' ))}}
        run: |
          echo "::notice::[NPM] Publishing libraries: $LIBRARIES"

          # Validate inputs to prevent injection
          if [[ ! "$LIBRARIES" =~ ^[a-zA-Z0-9_,-]+$ ]]; then
            echo "::error::[NPM] Invalid input 'libraries': contains invalid characters"
            echo "::error::[NPM] Expected: alphanumeric characters, underscore, hyphen, and comma only"
            echo "::error::[NPM] Received: $LIBRARIES"
            echo "FAILURE_REASON=invalid_input" >> $GITHUB_ENV
            exit 3
          fi

          libraries=$(echo "$LIBRARIES" | tr "," "\n")
          for library in $libraries
          do
            # Sanitize library name
            library=$(echo "$library" | sed 's/[^a-zA-Z0-9_-]//g')
            if [[ -z "$library" ]]; then
              echo "::warning::[NPM] Skipping empty library name after sanitization"
              continue
            fi

            latest_version=$(npm view "$(jq -r ".name" "${LIBRARY_PATH}/${library}/package.json")" dist-tags.latest 2>/dev/null || echo "0.0.0")
            package_version=$(jq -r ".version" "${LIBRARY_PATH}/${library}/package.json")

            if [[ "$latest_version" != "$package_version" ]]; then
              echo "::notice::[NPM] Publishing ${library}: ${latest_version} -> ${package_version}"
              npm publish "${LIBRARY_PATH}/${library}/" --access public --dry-run
              npm publish "${LIBRARY_PATH}/${library}/" --access public
            else
              echo "::notice::[NPM] Skipping ${library}: version ${package_version} already published"
            fi
          done
        env:
          LIBRARIES: ${{ inputs.libraries }}
          NPM_NAMESPACE: ${{ inputs.npm_namespace }}
          LIBRARY_PATH: ${{ inputs.library_path }}

      - name: publish single npm library
        if: ${{ inputs.libraries == '' && steps.check_artifact_exists.outputs.exists == 'true' && (!startsWith(github.repository, format('{0}/n8n-nodes', github.repository_owner)) || (startsWith(github.repository, format('{0}/n8n-nodes', github.repository_owner)) && inputs.n8n_verifiable_node != 'true' ))}}
        run: |
          path_to_package_json=$(find . -name "package.json" | head -n 1)

          latest_version=$(npm view "$(jq -r ".name" "$path_to_package_json")" dist-tags.latest 2>/dev/null || echo "0.0.0")
          package_version=$(jq -r ".version" "$path_to_package_json")

          if [[ "$latest_version" != "$package_version" ]]; then
            if [[ "${LIBRARY_PATH}" == "dist" ]]; then
              npm publish --access public --dry-run
              npm publish --access public
            else
              npm publish "${LIBRARY_PATH}"/ --access public --dry-run
              npm publish "${LIBRARY_PATH}"/ --access public
            fi
          fi
        env:
          NPM_NAMESPACE: ${{ inputs.npm_namespace }}
          LIBRARY_PATH: ${{ inputs.library_path }}

      - name: generate SBOM
        if: ${{ inputs.enable_sbom_attestation == 'true' && (inputs.tool == 'npm' || inputs.tool == 'yarn') }}
        run: |
          echo "::notice::[SBOM] Generating SBOM in $SBOM_FORMAT format"

          # Create SBOM directory
          mkdir -p sbom

          # Determine package manager and lock file
          if [[ "$TOOL" == "npm" ]]; then
            LOCK_FILE="package-lock.json"
          elif [[ "$TOOL" == "yarn" ]]; then
            LOCK_FILE="yarn.lock"
          fi

          # Generate SBOM using GitHub's SBOM tool
          if [[ "$SBOM_FORMAT" == "spdx" ]]; then
            npx @cyclonedx/cyclonedx-npm --output-file sbom/sbom.spdx.json --spec-version 2.3 --output-format JSON
          else
            npx @cyclonedx/cyclonedx-npm --output-file sbom/sbom.cyclonedx.json --spec-version 1.4
          fi

          echo "::notice::[SBOM] SBOM generated successfully"
        env:
          TOOL: ${{ inputs.tool }}
          SBOM_FORMAT: ${{ inputs.sbom_format }}

      - name: attest SBOM
        if: ${{ inputs.enable_sbom_attestation == 'true' && (inputs.tool == 'npm' || inputs.tool == 'yarn') }}
        uses: actions/attest-sbom@v2
        with:
          subject-path: |
            ${{ inputs.root_dir }}/sbom/sbom.*.json
          sbom-path: |
            ${{ inputs.root_dir }}/sbom/sbom.*.json

      - name: upload SBOM artifact
        if: ${{ inputs.enable_sbom_attestation == 'true' && (inputs.tool == 'npm' || inputs.tool == 'yarn') }}
        uses: actions/upload-artifact@v4
        with:
          name: sbom-npm-libraries
          path: ${{ inputs.root_dir }}/sbom/
          retention-days: 90
          if-no-files-found: warn
